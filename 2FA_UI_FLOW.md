# 2FA Implementation UI Flow

This document describes the user interface flow for the Two-Factor Authentication implementation.

## UI Components Overview

### 1. TwoFactorAuth Component
Located at: `src/components/TwoFactorAuth.tsx`

**Features:**
- Clean, centered layout with icon-based visual distinction
- 6 individual input boxes for the verification code
- Auto-focus on first input on mount
- Auto-advance to next input when typing
- Backspace support to move to previous input
- Paste support (automatically distributes digits across inputs)
- Submit on Enter key when all 6 digits are entered
- Real-time error display
- Resend code button with 60-second cooldown (email only)
- Back to login link
- Loading state during verification

**Visual Design:**
- Material-UI components for consistent styling
- Email icon (ðŸ“§) or Security icon (ðŸ”’) at the top
- Large heading: "Two-Factor Authentication"
- Descriptive text based on method
- 6 large, centered input boxes (56px width each)
- Full-width blue verification button
- Centered helper text and links below

## User Flow Scenarios

### Scenario 1: Login with Email 2FA

1. **Login Page** (`/login`)
   - User enters email and password
   - Completes Turnstile security check
   - Clicks "Login" button

2. **Backend Returns 2FA Challenge**
   - Response: `{ requires2FA: true, twoFactorMethod: 'email', sessionId: '...' }`
   - Frontend automatically switches to 2FA view

3. **2FA Verification Page** (same card, different content)
   - Shows email icon
   - Title: "Two-Factor Authentication"
   - Subtitle: "Enter the 6-digit code sent to your email"
   - 6 input boxes for code entry
   - "Verify" button
   - "Resend Code" link (with countdown)
   - "Back to login" link

4. **User Actions:**
   - Types 6-digit code (or pastes it)
   - Clicks "Verify" or presses Enter
   - If correct: Redirected to `/admin/dashboard`
   - If incorrect: Error message displayed, can retry

### Scenario 2: Login with TOTP 2FA

1-2. Same as Email 2FA scenario

3. **2FA Verification Page** (TOTP variant)
   - Shows security/lock icon
   - Title: "Two-Factor Authentication"
   - Subtitle: "Enter the 6-digit code from your authenticator app"
   - 6 input boxes for code entry
   - "Verify" button
   - NO "Resend Code" link (TOTP codes are generated by app)
   - "Back to login" link

4. **User Actions:**
   - Opens authenticator app (Google Authenticator, Authy, etc.)
   - Types current TOTP code
   - Clicks "Verify"
   - If correct: Redirected to `/admin/dashboard`
   - If incorrect: Error message displayed, can retry

### Scenario 3: Signup with 2FA

Same flow as login, but starts from signup form:
1. User enters email, username, password
2. Completes Turnstile
3. Clicks "Sign Up"
4. If backend requires 2FA setup during signup, shows 2FA verification
5. Verifies and redirects to dashboard

### Scenario 4: Resending Email Code

1. User is on 2FA verification page (email method)
2. Didn't receive code or it expired
3. Clicks "Resend Code" link
4. Link shows "Resend in Xs" countdown for 60 seconds
5. After countdown, can click again
6. New code sent to email
7. User enters new code and verifies

## Code Structure

### Login Page State Management

```typescript
// 2FA state
const [show2FA, setShow2FA] = useState<boolean>(false);
const [twoFactorMethod, setTwoFactorMethod] = useState<'email' | 'totp'>('email');
const [twoFactorSessionId, setTwoFactorSessionId] = useState<string>('');
const [twoFactorLoading, setTwoFactorLoading] = useState<boolean>(false);
```

### Key Functions

1. **handleSubmit**: Submits login/signup, checks for 2FA requirement
2. **handle2FAVerify**: Verifies 2FA token via API
3. **handle2FAResend**: Resends email code (email method only)
4. **handle2FABack**: Returns to login/signup form

### Conditional Rendering

```typescript
{show2FA ? (
  <TwoFactorAuth
    method={twoFactorMethod}
    sessionId={twoFactorSessionId}
    onVerify={handle2FAVerify}
    onResendEmail={twoFactorMethod === 'email' ? handle2FAResend : undefined}
    loading={twoFactorLoading}
    error={error}
    onBack={handle2FABack}
  />
) : (
  // Login/Signup form
)}
```

## Error Handling

### Possible Errors:

1. **Invalid verification code**
   - Red alert below input boxes
   - Message: "Invalid verification code"
   - Inputs remain filled, user can edit

2. **Session expired**
   - Red alert: "Session expired or invalid"
   - Suggests clicking "Back to login" to start over

3. **Too many attempts**
   - Red alert: "Too many failed attempts. Please try again later."
   - May disable verify button

4. **Resend rate limit**
   - Shows countdown: "Resend in 45s"
   - Link disabled until countdown reaches 0

## Accessibility Features

1. **Keyboard Navigation:**
   - Tab through inputs
   - Arrow keys respected
   - Enter to submit
   - Backspace to go back

2. **Screen Readers:**
   - Proper ARIA labels on inputs
   - Error messages announced
   - Button states announced

3. **Visual:**
   - High contrast text
   - Clear focus indicators
   - Large input boxes (easy to click/tap)
   - Clear error messages

## Mobile Responsiveness

- Card adapts to screen size
- Input boxes scale appropriately
- Touch-friendly tap targets
- Virtual keyboard opens on input focus
- Works on iOS and Android

## Security Features

1. **Single-use codes**: Each code can only be used once
2. **Time-limited**: Sessions expire after 10 minutes
3. **Rate limiting**: Max attempts enforced by backend
4. **No code display**: Codes never shown in UI (user must check email/app)
5. **Secure transmission**: All API calls over HTTPS

## Testing Checklist

- [ ] Can enter code by typing
- [ ] Can paste 6-digit code
- [ ] Auto-focus and auto-advance work
- [ ] Backspace moves to previous input
- [ ] Enter key submits form
- [ ] Error messages display correctly
- [ ] Loading state shows during verification
- [ ] Resend button works with countdown (email)
- [ ] Back button returns to login
- [ ] Works on mobile devices
- [ ] Works with screen readers
- [ ] Works with keyboard only
- [ ] Handles all error cases gracefully

## Future Enhancements

1. **TOTP Setup Flow**: Allow users to enable TOTP in settings
2. **Backup Codes**: Generate and display backup codes
3. **Remember Device**: Option to skip 2FA on trusted devices
4. **SMS 2FA**: Add SMS as a third method
5. **Recovery Options**: Account recovery if 2FA device lost
6. **2FA Management**: Enable/disable 2FA in user settings
7. **Activity Log**: Show where and when 2FA was used
